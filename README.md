# clients-server-semaphores

Εντολές ώστε να εκτελεστεί ο κώδικας της εργασίας
make
./project1
pink_floyd_lyrics.txt
K
N
K: ο αριθμός των παιδιών
Ν: το πλήθος των αιτημάτων που θα ζητήσει το κάθε παιδί
Η παρούσα εργασία περιλαμβάνει τα αρχεία child.c , child.h, parent.c,
parent.h, main.c, shared_memory.h, pink_floyd_lyrics.txt και Makefile, για τα
οποία παρακάτω παρέχεται επεξήγηση για τη λειτουργία του κώδικα κάθε
αρχείου.
Αρχικά, το πρόγραμμα δέχεται ορίσματα από το τερματικό ένα αρχείο
κειμένου, τον αριθμό των παιδιών (child process) που θα πραγματοποιήσουν
αιτήματα (Κ) και το πλήθος των αιτημάτων που θα στείλει το κάθε παιδί (Ν)
προς τη διαδικασία γονέα (parent process). Το αίτημα που στέλνεται από τη
διαδικασία παιδί είναι ο αριθμός της γραμμής από το αρχείο txt που δόθηκε
από το τερματικό σαν όρισμα. Η διαδικασία γονέας θα ψάξει το αρχείο για να
επιστρέψει την αιτηθείσα γραμμή στην child process. Για την υλοποίηση του
παραπάνω σεναρίου έχει διαμορφωθεί κατάλληλα ο χώρος της
διαμοιραζόμενης μνήμης, στην οποία έχουν πρόσβαση τόσο η child process
όσο και η parent process. Ο χώρος της διαμοιραζόμενης μνήμης υπάρχει στο
header file shared_memory.h. Μετά το πέρας των αιτημάτων από κάθε παιδί,
εκτυπώνεται στην οθόνη και ο χρόνος που χρειάστηκε κάθε παιδί ώστε να
ολοκληρώσει τα αιτήματά του.
Για το ζητούμενο της εργασίας έχει υλοποιηθεί το πρότυπο producer-
consumer που αναφέρεται και στο βιβλίο του μαθήματος στην ενότητα 7.1 του
Abraham Silberschatz, όπου στην περίπτωση της εργασίας έχουμε έναν
consumer (parent process) και Κ producers (child process).
Αναλυτική περιγραφή του κάθε αρχείου:
shared_memory.h
Στο συγκεκριμένο αρχείο επικεφαλίδας γίνονται define το LINESIZE σε 101,
όπου αναπαριστά το μέγιστο μήκος της γραμμής εντός του αρχείου κειμένου
(100 χαρακτήρες + 1 για το \n) και το MAX_REQUESTS όπου αναπαριστά το
μέγιστο συνολικό πλήθος αιτημάτων από όλα τα παιδιά που είναι δυνατόν να
γίνουν (Κ * Ν). Έχει δηλωθεί MAX_REQUESTS = 10000. Έπίσης στο αρχείο
επικεφαλίδας shared_memory.h περιέχονται τα τμήματα που αποτελούν τηνδιαμοιραζόμενη μνήμη. Η διαμοιραζόμενη μνήμη θα αποτελείται από 2
τμήματα.
Το πρώτο κομμάτι της διαμοιραζόμενης μνήμης είναι τύπου struct request. Το
struct αυτό περιλαμβάνει έναν buffer με αριθμό θέσεων MAX_REQUESTS
που περιέχει struct request_item. Το struct request_item περιέχει τον αριθμό
του παιδιού (child_i) και τον αριθμό της γραμμής που ζητάει
(number_of_line).Εν συνεχεία το struct request, περιέχει 5 σημαφόρους. Ο
empty που αρχικοποιείται στον αριθμό των παιδιών, ο full στο 0, ο mutex στο
1 (για αμοιβαίο αποκλεισμό), ο lock στο 1 για αμοιβαίο αποκλεισμό στις
εντολές printf και ο my_turn στο 1 ώστε να επιτυγχάνεται κατάλληλα ο
συγχρονισμός μεταξύ της διαργασίας παιδί με τη διεργασίας γονέα. Επίσης,
περιέχεται και ο αριθμός των αιτημάτων που γίνονται (num_of_request).
Το δεύτερο κομμάτι της διαμοιραζόμενης μνήμης που αφορά στην απάντηση
του αιτήματος και είναι τύπου struct response. Το struct αυτό περιέχει έναν
πίνακα χαρακτήρων μεγέθους LINESIZE όπου θα γραφτεί η γραμμή που θα
επιστρέψει ο γονέας στο αίτημα ενός παιδιού. Επίσης, έναν σημαφόρο τον
buff_sem (αρχικοποιημένο στο 0) που το παιδί τον κάνει down καθώς
περιμένει να ικανοποιηθεί το αίτημά του και ο γονέας τον κάνει up μόλις βρει
την γραμμή που ζητήθηκε ψάχνοντας το αρχείο κειμένου .Τέλος,
περιλαμβάνονται 3 ακέραιοι, για τον αριθμό της απάντησης
(num_of_response), για τον αριθμό του παιδιού στο οποίο θα απαντήσει ο
γονέας (child_res) και για τον αριθμό της γραμμής που ζήτησε το παιδί
(line_you_asked).
main.c
Αρχικά πραγματοποιείται έλεγχος για τον αν έχει δοθεί σωστό πλήθος
ορισμάτων από το τερματικό (4 ορίσματα καθώς συμπεριλαμβάνεται και το
όνομα του εκτελέσιμου αρχείου) και έλεγχος ώστε το γινόμενο των παιδιών με
τα αιτήματα να μην υπερβαίνουν το MAX_REQUESTS (στην συγκεκριμένη
περίπτωση έχει γίνει defined σε 10.000).
Στη συνέχεια βρίσκεται ο αριθμός των γραμμών του txt file και ο αριθμός
αυτός εκχωρείται στη μεταβλητή lines (αν δοθεί όρισμα το pink_floyd_lyrics.txt
τότε lines=85).
Δημιουργείται το τμήμα διαμοιραζόμενης μνήμης και γίνεται attach με τις
συναρτήσεις shmget και shmat, μαζί με τον κατάλληλο έλεγχο σε περίπτωση
που αποτύχει κάποια συνάρτηση. Η διαμοιραζόμενη μνήμη αποτελείται από 2
κομμάτια, ένα τμήμα για το αίτημα και ένα για την απόκριση του αιτήματος. Για
το λόγο αυτό οι συναρτήσεις shmget και shmat εκτελούνται 2 φορές η κάθε
μία.
Έπειτα, αρχικοποιούνται οι σημαφόροι με τη συνάρτηση sem_init. Οι τιμές με
τις οποίες αρχικοποιούνται έχουν αναφερθεί παραπάνω στην επεξήγηση του
αρχείου shared_memory.hΣτη συνέχεια, εκτελείται μια επανάληψη ώστε να δημιουργηθούν τα Κ παιδιά,
όπου η συνάρτηση fork() επιστρέφει το process id (pid) το οποίο κρατείται
στον πίνακα pid[ ] που έχει Κ θέσεις.
Σε περίπτωση που το pid είναι 0, τότε αναφερόμαστε στην διαδικασία παδί.
Μέσα στη διαδικασία παιδί εφαρμόζεται η srand με feed το άθροισμα getpid()
(συνάρτηση που επιστρέφει το process id της καλούσας διαδικασίας) και τη
συνάρτηση time(NULL), ώστε να είναι βέβαιο ότι κάθε παιδί σε κάθε του
αίτημα θα ζητάει και διαφορετική γραμμή από το αρχείο κειμένου. Ύστερα,
υλοποιείται μια επανάληψη Ν φορές, όσες δηλαδή είναι οι αιτήσεις που θα
πραγματοποιήσει κάθε παιδί. Μέσα στην επανάληψη αυτή καλείται η
συνάρτηση που υλοποιεί την child process (ο πηγαίος κώδικάς της βρίσκεται
στο αρχείο child.c το οποίο θα εξηγηθεί παρακάτω για τη λειτουργία της). Η
συνάρτηση child επιστρέφει τον χρόνο που χρειάστηκε για να εκτελεστεί η
παρούσα συνάρτηση, εκχωρείται στη μεταβλητή total_time τύπου double.
Μόλις το συγκεκριμένο παιδί ολοκληρώσει τα Ν αιτήματα, ο χρόνος διαιρείται
με τον αριθμό των αιτημάτων, καθώς στην εκφώνηση της εργασίας ζητείται ο
μέσος χρόνος ο οποίος παρέρχεται από την υποβολή ενός αιτήματος μέχρι τη
λήψη της αντίστοιχης απάντησης. Τέλος, γίνεται αμοιβαίος αποκλεισμός ώστε
να εκτυπωθεί ο μέσος χρόνος εκτέλεσης του κάθε παιδιού (ο σημαφόρος lock
γίνεται down (sem_wait) πριν την εντολή printf και up (sem_post) μετά την
εντολή printf).
Σε περίπτωση που το pid δεν είναι 0, τότε αναφερόμαστε στην γονεϊκή
διαδικασία, η οποία είναι έξω από την επανάληψη που δημιουργεί τα παιδιά
και εκτελείται Κ * Ν φορές, δηλαδή για όλα τα αιτήματα όλων των παιδιών.
Καλείται, λοιπόν, η συνάρτηση parent που δεν επιστρέφει κάποια τιμή (είναι
τύπου void). Ο κώδικας της συνάρτησης parent υπάρχει στο αρχείο parent.c
και η λειτουργία της εξηγείται παρακάτω.
Εφόσον έχουν ικανοποιηθεί όλα τα αιτήματα ( ο αριθμός των αιτημάτων και ο
αριθμός των απαντήσεων είναι Κ*Ν) τότε εκτελείται η συνάρτηση wait με
όρισμα το status ώστε να ολοκληρωθούν όλα τα παιδιά.
Στο τέλος, καταστρέφονται όλοι οι σημαφόροι που χρειάστηκαν με τη
συνάρτηση sem_destroy, καθώς και τα 2 κομμάτια της διαμοιραζόμενης
μνήμης, μέσω των συναρτήσεων shmdt και shmctl, οι οποίες καλούνται 2
φορές η κάθε μία.
child.c
Στο αρχείο αυτό υπάρχει ο κώδικας της συνάρτησης child. Η συνάρτηση child
δέχεται ως ορίσματα έναν δείκτη σε request, έναν δείκτη σε response ώστε να
έχει πρόσβαση στο κομμάτι request και στο κομμάτι response της
διαμοιραζόμενης μνήμης αντίστοιχα. Επίσης έναν ακέραιο (το όνομα της
μεταβλητής λέγεται child) που δείχνει τον αριθμό του παιδιού, έναν ακόμη
ακέραιο που γνωστοποιεί στη συνάρτηση τον αριθμό των γραμμών του
αρχείου κειμένου και άλλες 2 μεταβλητές τύπου clock_t που χρειάζονται στην
εύρεση του χρόνου εκτέλεσης του παιδιού.Αρχικά, εκτελείται η συνάρτηση clock που σηματοδοτεί την αρχή του
αιτήματος. Ύστερα ο σημαφόρος my_turn γίνεται down ώστε να μην ξεκινήσει
άλλο αίτημα. Στη συνέχεια, γίνονται down οι σημαφόροι empty (πρόκειται να
προστεθεί ένα ακόμα αίτημα στον buffer) και mutex (αμοιβαίος αποκλεισμός).
Εισάγονται στη διαμοιραζόμενη μνήμη τα στοιχεία του αιτήματος, στο κομμάτι
του request, δηλαδή ποιο παιδί έχει κάνει αίτημα και ποια γραμμή ζητάει.
Εκτυπώνεται ανάλογο μήνυμα έπειτα από αμοιβαίο αποκλεισμό με τη βοήθεια
του σημαφόρου lock. Ο αριθμός των αιτημάτων αυξάνεται κατά 1 και οι
σημαφόροι empty και mutex γίνονται up, καθώς έχει ολοκληρωθεί η
διαδικασία του αιτήματος. Στο σημείο αυτό, το παιδί με το να κάνει down το
σημαφόρο buff_sem που αφορά στην απάντηση για το συγκεκριμένο παιδί
(res[child].buff_sem), περιμένει να λάβει απάντηση από το γονέα. Μόλις λάβει
απάντηση εκτελεί την συνάρτηση clock για να βρει τον χρόνο που χρειάστηκε
για να τελειώσει το αίτημα και ύστερα τυπώνει την απάντηση που έγραψε
μέσα στην διαμοιραζόμενη μνήμη ο γονεάς (μέσα στον πίνακα line[101] που
βρίσκεται στο κομμάτι response).
Τέλος, η συνάρτηση process επιστρέφει τον χρόνο που χρειάστηκε, τη
μεταβλητή total_time.


parent.c

Η συνάρτηση parent δέχεται ορίσματα: έναν δείκτη σε request, έναν δείκτη σε
response ώστε να έχει πρόσβαση στο κομμάτι request και στο κομμάτι
response της διαμοιραζόμενης μνήμης αντίστοιχα. Επίσης, το αρχείο
κειμένου. Αρχικά, κάνει down τους σημαφόρους full (αφαιρείται ένα αίτημα)
και mutex. Εν συνεχεία ο αριθμός του παιδιού που έκανε το αίτημα γράφεται
στην διαμοιραζόμενη μνήμη του κομματιού response, καθώς και η γραμμή
που ζήτησε το παιδί ώστε ο γονέας να αναζητήσει τη συγκεκριμένη γραμμή. Ο
γονέας αφού ξέρει ποια γραμμή έχει ζητήσει το παιδί αναζητά στο αρχείο
κειμένου την συγκεκριμένη γραμμή και έπειτα κάνει up το σημαφόρο buff_sem
που αναφέρεται στο συγκεκριμένο παιδί
(sem_post(&res[res->child_res].buff_sem)), ώστε η child process να
σταματήσει να περιμένει καθώς τώρα γνωρίζει ότι έχει ικανοποιηθεί το αίτημά
της. Οι απαντήσεις που έχει εκπληρώσει ο γονέας αυξάνονται κατά 1 και ο
σημαφόρος my_turn γίνεται up ώστε να ξεκινήσει κάποιο άλλο αίτημα να
ζητηθεί από το παιδί. Τέλος, οι σημαφόροι mutex και empty γίνονται up, όπως
στο πρότυπο producer-consumer για τη διαδικασία του consumer. 
